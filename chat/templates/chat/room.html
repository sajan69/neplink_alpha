{% extends 'base.html' %}
{% load file_seperator %}
{% load static %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><a href="{% url 'chat:chat_list' %}" class="text-decoration-none text-white">Chat Rooms</a></h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for room in rooms %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{% url 'chat:chat_room' room.id %}" class="text-decoration-none text-dark">{{ room.name }}</a>
                                <button class="btn btn-sm btn-outline-success call-btn" data-room-id="{{ room.id }}">
                                    <i class="fas fa-phone-alt"></i>
                                </button>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">{{ room.name|default:"Chat Room" }}</h3>
                    <button id="join-call" class="btn btn-success">
                        <i class="fas fa-video me-2"></i>Start Video Call
                    </button>
                </div>
                <div class="card-body" style="height: 70vh;">
                    <div id="chat-messages" class="overflow-auto mb-3" style="height: calc(100% - 60px);">
                        {% for message in messages %}
                            <div class="mb-3 p-2 {% if message.sender.username == request.user.username %}bg-light text-end{% endif %}">
                                <strong>{{ message.sender.username }}:</strong>
                                {% if message.is_file %}
                                    {% if message.file.url|file_seperator == 'image' %}
                                        <a href="{{ message.file.url }}" target="_blank">
                                            <img src="{{ message.file.url }}" class="img-thumbnail" style="max-width: 200px;">
                                        </a>
                                    {% elif message.file.url|file_seperator == 'video' %}
                                        <video src="{{ message.file.url }}" controls class="w-100"></video>
                                    {% elif message.file.url|file_seperator == 'audio' %}
                                        <audio src="{{ message.file.url }}" controls></audio>
                                    {% else %}
                                        <a href="{{ message.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-file"></i> {{ message.file.name }}
                                        </a>
                                    {% endif %}
                                {% else %}
                                    <span class="ms-2">{{ message.content }}</span>
                                {% endif %}
                                <small class="text-muted d-block">{{ message.timestamp|date:"H:i" }}</small>
                            </div>
                        {% endfor %}
                    </div>
                    <form id="chat-form" class="mt-3">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" id="chat-message-input" class="form-control" placeholder="Type your message..." required>
                            <label for="file-input" class="btn btn-outline-secondary mb-0">
                                <i class="fas fa-paperclip"></i>
                            </label>
                            <input type="file" id="file-input" style="display: none;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="videoCallModal" tabindex="-1" aria-labelledby="videoCallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoCallModalLabel">Video Call</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="video-container" class="row">
                    <div class="col-md-6">
                        <div id="local-video" class="w-100 h-100 bg-dark"></div>
                    </div>
                    <div class="col-md-6">
                        <div id="remote-video" class="w-100 h-100 bg-dark"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="leave-call" class="btn btn-danger">
                    <i class="fas fa-phone-slash me-2"></i>End Call
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
<script>
    const roomId = {{ room.id }};
    const userId = {{ request.user.id }};
    let currentCallLogId = null;

    const chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomId + '/'
    );

    chatSocket.onopen = function(e) {
        console.log('WebSocket connection established');
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log(data);
        const chatMessages = document.querySelector('#chat-messages');
        let messageHTML = `
            <div class="mb-3 p-2 ${data.username === '{{ request.user.username }}' ? 'bg-light text-end' : ''}">
                <strong>${data.username}:</strong> 
        `;
        
        if (data.is_file) {
            
              // Extract file extension from the URL
        const fileUrl = data.file_url;
        const fileExtension = fileUrl.split('.').pop().toLowerCase(); // Get the file extension

        // Determine file type based on the extension
        let fileType = '';
        if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(fileExtension)) {
            fileType = 'image';
        } else if (['mp4', 'mkv', 'webm', 'ogg'].includes(fileExtension)) {
            fileType = 'video';
        } else if (['mp3', 'wav', 'ogg'].includes(fileExtension)) {
            fileType = 'audio';
        } else {
            fileType = 'other';
        }

            if (fileType === 'image') {
                messageHTML += `
                    <a href="${fileUrl}" target="_blank">
                        <img src="${fileUrl}" class="img-thumbnail" style="max-width: 200px;" alt="Image File">
                    </a>
                `;
            } else if (fileType === 'video') {
                messageHTML += `
                    <video src="${fileUrl}" controls class="w-100"></video>
                `;
            } else if (fileType === 'audio') {
                messageHTML += `
                    <audio src="${fileUrl}" controls></audio>
                `;
            } else {
                messageHTML += `
                    <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-file"></i> ${data.file_name}
                    </a>
                `;
            }
        } else {
            messageHTML += `<span class="ms-2">${data.message}</span>`;
        }
        
        messageHTML += `
                <small class="text-muted d-block">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
            </div>
        `;
        
        chatMessages.innerHTML += messageHTML;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    chatSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
    
    chatSocket.onclose = function(e) {
        console.log('WebSocket connection closed');
    };

    document.querySelector('#chat-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'type': 'message',
            'message': message,
            'user_id': userId
        }));
        messageInputDom.value = '';
    };
    
    document.querySelector('#file-input').onchange = function(e) {
        const file = e.target.files[0];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('room_id', roomId);
        formData.append('user_id', userId);
    
        fetch('/chat/upload_file/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            chatSocket.send(JSON.stringify({
                'type': 'file_share',
                'user_id': userId,
                'file_url': data.file_url,
                'file_name': file.name,
                'file_type': data.file_type
            }));
            console.log('File uploaded:', data);
        })
        .catch(error => {
            console.error('Error uploading file:', error);
        });
    
        e.target.value = '';
    };

    let rtc = {
        client: null,
        localAudioTrack: null,
        localVideoTrack: null
    };

    let options = {
        appId: null,
        channel: null,
        token: null,
        uid: userId
    };

    async function joinCall() {
        try {
            const response = await fetch(`/chat/generate_agora_token/${roomId}/`);
            const data = await response.json();
            
            options.appId = data.app_id;
            options.channel = data.channel_name;
            options.token = data.token;
            currentCallLogId = data.call_log_id;

            rtc.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
            
            await rtc.client.join(options.appId, options.channel, options.token, options.uid);
            
            rtc.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            rtc.localVideoTrack = await AgoraRTC.createCameraVideoTrack();
            
            await rtc.client.publish([rtc.localAudioTrack, rtc.localVideoTrack]);
            
            const localVideoContainer = document.getElementById("local-video");
            rtc.localVideoTrack.play(localVideoContainer);
            
            $('#videoCallModal').modal('show');
            
            rtc.client.on("user-published", async (user, mediaType) => {
                await rtc.client.subscribe(user, mediaType);
                if (mediaType === "video") {
                    const remoteVideoContainer = document.getElementById("remote-video");
                    user.videoTrack.play(remoteVideoContainer);
                }
                if (mediaType === "audio") {
                    user.audioTrack.play();
                }
            });

        } catch (error) {
            console.error("Error joining call:", error);
        }
    }

    async function leaveCall() {
        rtc.localAudioTrack.close();
        rtc.localVideoTrack.close();
        await rtc.client.leave();
        $('#videoCallModal').modal('hide');

        if (currentCallLogId) {
            try {
                const response = await fetch(`/chat/end_call/${currentCallLogId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    console.log('Call ended successfully');
                } else {
                    console.error('Error ending call:', data.error);
                }
            } catch (error) {
                console.error('Error ending call:', error);
            }
            currentCallLogId = null;
        }
    }

    document.getElementById('join-call').addEventListener('click', joinCall);
    document.getElementById('leave-call').addEventListener('click', leaveCall);

    // Ensure the modal is hidden when closed
    $('#videoCallModal').on('hidden.bs.modal', function (e) {
        leaveCall();
    });
</script>
{% endblock %}