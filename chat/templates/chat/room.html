{% extends 'base.html' %}
{% load file_seperator %}
{% load static %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <!-- Sidebar with Chat Rooms -->
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><a href="{% url 'chat:chat_list' %}" class="text-decoration-none text-white">Chat Rooms</a></h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for room in rooms %}
                        <a href="{% url 'chat:chat_room' room.id %}" class="text-decoration-none text-dark">
                            <li class="list-group-item d-flex justify-content-center align-items-center">
                                    {% if room.is_group_chat %}
                                        <i class="fas fa-users fa-2x mr-3 text-primary"></i>
                                        <div class="row">
                                            <div class="col md-3">
                                                <span class="font-weight-bold">{{ room.name }}</span>
                                            </div>
                                            <div class="col md-9">
                                                <small class="text-muted d-block">Group Chat</small>
                                            </div>
                                        </div>  
                                       
                                    {% else %}
                                        {% for participant in room.participants.all %}
                                            {% if participant != request.user %}
                                                <img src="{% if participant.profile_pic %}{{ participant.profile_pic.url }}{% else %}{% static 'img/default_profile_pic.png' %}{% endif %}
                                                " alt="{{ participant.username }}" class="rounded-circle mr-3" style="width: 50px; height: 50px;">
                                                <span class="font-weight-bold">{{ participant.username }}</span>
                                                {% if participant.is_online %}
                                                <span class="badge bg-success ms-2">Online</span>
                                                {% else %}
                                                    <span class="badge bg-secondary ms-2">Active: {{ participant.last_online }}</span>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    {% comment %} <div>
                                        {% if ongoing_call %}
                                        <button class="btn btn-sm btn-outline-info join-call-btn" data-room-id="{{ room.id }}" data-call-log-id="{{ ongoing_call.id }}" data-call-type="{{ ongoing_call.call_type }}">
                                            <i class="fas fa-phone-volume"></i> Join Call
                                            </button>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-success call-btn" data-room-id="{{ room.id }}" data-call-type="audio">
                                                <i class="fas fa-phone-alt"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary call-btn" data-room-id="{{ room.id }}" data-call-type="video">
                                                    <i class="fas fa-video"></i>
                                                    </button>
                                                    {% endif %}
                                                    </div> {% endcomment %}
                            </li>
                        </a>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Chat and Call Interface -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    {% if room.is_group_chat %}
                        <div class="d-flex align-items-center">
                            <h3 class="mb-0 me-3">{{ room.name|default:"Chat Room" }}</h3>
                            <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#groupMembersModal">
                                <i class="fas fa-users me-2"></i>View Members
                            </button>
                        </div>
                    {% else %}
                        {% for participant in room.participants.all %}
                            {% if participant != request.user %}
                                <div class="d-flex align-items-center">
                                    <img src="{% if participant.profile_pic %}{{ participant.profile_pic.url }}{% else %}{% static 'img/default_profile_pic.png' %}{% endif %}" alt="{{ participant.username }}" class="rounded-circle me-2" style="width: 50px; height: 50px;">
                                    <span class="font-weight-bold">{{ participant.username }}</span>
                                    {% if participant.is_online %}
                                        <span class="badge bg-success ms-2">Online</span>
                                    {% else %}
                                        <span class="badge bg-secondary ms-2">Active: {{ participant.last_online }}</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    <div>
                        {% if ongoing_call %}
                            <button id="leave-call-btn" class="btn btn-danger me-2">
                                <i class="fas fa-phone-slash me-2"></i>Leave Call
                            </button>
                            <button id="mute-audio-btn" class="btn btn-secondary me-2">
                                <i class="fas fa-microphone-slash me-2"></i>Mute
                            </button>
                            <button id="mute-video-btn" class="btn btn-secondary">
                                <i class="fas fa-video-slash me-2"></i>Stop Video
                            </button>
                        {% else %}
                            <button class="btn btn-sm btn-outline-warning call-btn" data-room-id="{{ room.id }}" data-call-type="audio">
                                <i class="fas fa-phone-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning call-btn" data-room-id="{{ room.id }}" data-call-type="video">
                                <i class="fas fa-video"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body" style="height: 70vh;">
                    <div id="chat-messages" class="overflow-auto mb-3" style="height: calc(100% - 60px);">
                        {% for message in messages %}
                            <div class="mb-3 p-2 {% if message.sender.username == request.user.username %}bg-light text-end{% endif %}">
                                <strong>{{ message.sender.username }}:</strong>
                                {% if message.is_file %}
                                    {% if message.file.url|file_seperator == 'image' %}
                                        <a href="{{ message.file.url }}" target="_blank">
                                            <img src="{{ message.file.url }}" class="img-thumbnail" style="max-width: 200px;" alt="Shared image">
                                        </a>
                                    {% elif message.file.url|file_seperator == 'video' %}
                                        <video src="{{ message.file.url }}" controls class="w-100">
                                            Your browser does not support the video tag.
                                        </video>
                                    {% elif message.file.url|file_seperator == 'audio' %}
                                        <audio src="{{ message.file.url }}" controls>
                                            Your browser does not support the audio tag.
                                        </audio>
                                    {% else %}
                                        <a href="{{ message.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-file"></i> {{ message.file.name }}
                                        </a>
                                    {% endif %}
                                {% else %}
                                    <span class="ms-2">{{ message.content }}</span>
                                {% endif %}
                                <small class="text-muted d-block">{{ message.timestamp|date:"H:i" }}</small>
                            </div>
                        {% endfor %}
                    </div>
                    <form id="chat-form" class="mt-3">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" id="chat-message-input" class="form-control" placeholder="Type your message..." required>
                            <label for="file-input" class="btn btn-outline-secondary mb-0">
                                <i class="fas fa-paperclip"></i>
                            </label>
                            <input type="file" id="file-input" style="display: none;" aria-label="File attachment">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Group Members Modal -->
        {% if room.is_group_chat %}
        <div class="modal fade" id="groupMembersModal" tabindex="-1" aria-labelledby="groupMembersModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="groupMembersModalLabel">Group Members: {{room.participants.all|length}}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="list-group">
                            {% for participant in room.participants.all %}
                            <a href="#" class="text-decoration-none">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <img src="{% if participant.profile_pic %}{{ participant.profile_pic.url }}{% else %}{% static 'img/default_profile_pic.png' %}{% endif %}" alt="{{ participant.username }}" class="rounded-circle me-2" style="width: 40px; height: 40px;">
                                        <span>{{ participant.username }}</span>
                                    </div>
                                    {% if participant.is_online %}
                                        <span class="badge bg-success">Online</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Offline</span>
                                    {% endif %}
                                </li>
                            </a>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Call Interface Modal -->
<div class="modal fade" id="callModal" tabindex="-1" aria-labelledby="callModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="callModalLabel">{{ room.name|default:"Chat Room" }} - Call</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div id="local-video-container"></div>
            </div>
            <div class="col-md-6">
              <div id="remote-video-container"></div>
            </div>
          </div>
          <div class="mt-3 text-center">
            <button id="mute-audio-btn" class="btn btn-primary me-2">Mute Audio</button>
            <button id="mute-video-btn" class="btn btn-primary me-2">Mute Video</button>
            <button id="leave-call-btn" class="btn btn-danger">Leave Call</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
<!-- Agora SDK Script -->
<script src="https://cdn.agora.io/sdk/release/AgoraRTC_N.js"></script>
<script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.17.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const roomId = {{ room.id }};
    const userId = {{ request.user.id }};
    let currentCallLogId = null;
    let client = null;
    let localAudioTrack = null;
    let localVideoTrack = null;
    async function handleUserPublished(user, mediaType) {
        await client.subscribe(user, mediaType);
        if (mediaType === "video") {
            const remoteVideoTrack = user.videoTrack;
            const remotePlayerContainer = document.createElement("div");
            remotePlayerContainer.id = user.uid.toString();
            remotePlayerContainer.style.width = "100%";
            remotePlayerContainer.style.height = "100%";
            document.getElementById("remote-video-container").append(remotePlayerContainer);
            remoteVideoTrack.play(remotePlayerContainer);
        }
        if (mediaType === "audio") {
            user.audioTrack.play();
        }
    }
    
    function handleUserUnpublished(user) {
        const remotePlayerContainer = document.getElementById(user.uid.toString());
        if (remotePlayerContainer) {
            remotePlayerContainer.remove();
        }
    }
    // Initialize Agora
    async function initializeAgora(appId, token, channel, uid, callType) {
        try {
            client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    
            client.on("user-published", handleUserPublished);
            client.on("user-unpublished", handleUserUnpublished);
    
            await client.join(appId, channel, token, uid);
            console.log("Joined Agora channel:", channel);
    
            if (callType === 'video') {
                try {
                    localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack();
                    localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                    localTracks.videoTrack.play("local-video-container");
                } catch (error) {
                    console.error("Error creating video track:", error);
                    alert("Failed to access camera. Please check your camera permissions and try again.");
                    await endCall();
                    return;
                }
            } else {
                try {
                    localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                } catch (error) {
                    console.error("Error creating audio track:", error);
                    alert("Failed to access microphone. Please check your microphone permissions and try again.");
                    await endCall();
                    return;
                }
            }
    
            await client.publish(Object.values(localTracks));
            console.log("Published local tracks");
    
            // Show the call modal
            callModal.show();
        } catch (error) {
            console.error("Agora initialization error:", error);
            alert("Failed to join the call. Please try again later.");
            await endCall();
        }
    }
async function checkAndRequestPermissions(callType) {
    try {
        if (callType === 'video') {
            await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        } else {
            await navigator.mediaDevices.getUserMedia({ audio: true });
        }
        return true;
    } catch (error) {
        console.error("Error requesting permissions:", error);
        if (error.name === 'NotAllowedError') {
            alert("Please grant permission to use your camera and/or microphone to make calls.");
        } else {
            alert("An error occurred while accessing your media devices. Please check your settings and try again.");
        }
        return false;
    }
}
    // Join Agora channel
    async function joinChannel(token, channel, uid) {
        await client.join("YOUR_AGORA_APP_ID", channel, token, uid);
        localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
        localVideoTrack = await AgoraRTC.createCameraVideoTrack();
        await client.publish([localAudioTrack, localVideoTrack]);
        
        const localPlayerContainer = document.createElement("div");
        localPlayerContainer.id = uid.toString();
        localPlayerContainer.style.width = "100%";
        localPlayerContainer.style.height = "100%";
        document.getElementById("local-video-container").append(localPlayerContainer);
        localVideoTrack.play(localPlayerContainer);
    }

    // Initiate call
    async function initiateCall(callType) {
        if (!(await checkAndRequestPermissions(callType))) {
            return;
        }
    
        const response = await fetch('/chat/initiate_call/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ room_id: roomId, call_type: callType })
        });
        const data = await response.json();
        
        if (data.status === 'Call initiated') {
            currentCallLogId = data.call_log_id;
            const tokenResponse = await fetch(`/chat/get_agora_token/?channel=room_${roomId}`);
            const tokenData = await tokenResponse.json();
            
            await initializeAgora(tokenData.app_id, tokenData.token, `room_${roomId}`, tokenData.uid, callType);
        } else {
            alert('A call is already in progress in this room.');
        }
    }

    // End call
    async function endCall() {
        if (client) {
            try {
                await client.leave();
                console.log("Left the Agora channel");
            } catch (error) {
                console.error("Error leaving Agora channel:", error);
            }
        }
    
        // Close local tracks
        for (let trackName in localTracks) {
            let track = localTracks[trackName];
            if (track) {
                track.stop();
                track.close();
                localTracks[trackName] = null;
            }
        }
    
        // Hide the call modal
        callModal.hide();
    
        // End the call in the backend
        if (currentCallLogId) {
            try {
                const response = await fetch('/chat/end_call/', {
                    method: 'POST',
                    body: JSON.stringify({
                        call_log_id: currentCallLogId
                    }),
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.status === 'Call ended') {
                    console.log('Call ended successfully');
                }
            } catch (error) {
                console.error('Error ending call:', error);
            }
        }
    
        currentCallLogId = null;
        currentCallType = null;
    }

    // Event listeners
    document.querySelector('.call-btn[data-call-type="audio"]').addEventListener('click', () => initiateCall('audio'));
    document.querySelector('.call-btn[data-call-type="video"]').addEventListener('click', () => initiateCall('video'));
    document.getElementById('leave-call-btn').addEventListener('click', endCall);
    
    document.getElementById('mute-audio-btn').addEventListener('click', () => {
        if (localAudioTrack.muted) {
            localAudioTrack.setMuted(false);
            document.getElementById('mute-audio-btn').textContent = 'Mute Audio';
        } else {
            localAudioTrack.setMuted(true);
            document.getElementById('mute-audio-btn').textContent = 'Unmute Audio';
        }
    });
    
    document.getElementById('mute-video-btn').addEventListener('click', () => {
        if (localVideoTrack.muted) {
            localVideoTrack.setMuted(false);
            document.getElementById('mute-video-btn').textContent = 'Mute Video';
        } else {
            localVideoTrack.setMuted(true);
            document.getElementById('mute-video-btn').textContent = 'Unmute Video';
        }
    });
</script>
<script>
   
   
    const username = "{{ request.user.username }}";
    let currentCallLogId = null;
    let currentCallType = null;

    let client = null;
    let localTracks = {
        videoTrack: null,
        audioTrack: null
    };
    let remoteUsers = {};

    // Initialize Bootstrap Modal
    const callModal = new bootstrap.Modal(document.getElementById('callModal'), {
        backdrop: 'static',
        keyboard: false
    });

    // WebSocket for Chat (existing code)
    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host +
        '/ws/chat/' + roomId + '/'
    );

    chatSocket.onopen = function(e) {
        console.log('WebSocket connection established');
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log(data);
        const chatMessages = document.querySelector('#chat-messages');
        let messageHTML = `
            <div class="mb-3 p-2 ${data.username === username ? 'bg-light text-end' : ''}">
                <strong>${data.username}:</strong> 
        `;
        
        if (data.is_file) {
            const fileUrl = data.file_url;
            const fileExtension = fileUrl.split('.').pop().toLowerCase();

            let fileType = '';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(fileExtension)) {
                fileType = 'image';
            } else if (['mp4', 'mkv', 'webm', 'ogg'].includes(fileExtension)) {
                fileType = 'video';
            } else if (['mp3', 'wav', 'ogg'].includes(fileExtension)) {
                fileType = 'audio';
            } else {
                fileType = 'other';
            }

            if (fileType === 'image') {
                messageHTML += `
                    <a href="${fileUrl}" target="_blank">
                        <img src="${fileUrl}" class="img-thumbnail" style="max-width: 200px;" alt="Image File">
                    </a>
                `;
            } else if (fileType === 'video') {
                messageHTML += `
                    <video src="${fileUrl}" controls class="w-100"></video>
                `;
            } else if (fileType === 'audio') {
                messageHTML += `
                    <audio src="${fileUrl}" controls></audio>
                `;
            } else {
                messageHTML += `
                    <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-file"></i> ${data.file_name}
                    </a>
                `;
            }
        } else {
            messageHTML += `<span class="ms-2">${data.message}</span>`;
        }
        
        messageHTML += `
                <small class="text-muted d-block">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
            </div>
        `;
        
        chatMessages.innerHTML += messageHTML;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    chatSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
    
    chatSocket.onclose = function(e) {
        console.log('WebSocket connection closed');
    };

    // Chat Form Submission
    document.querySelector('#chat-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'type': 'message',
            'message': message,
            'user_id': userId
        }));
        messageInputDom.value = '';
    };
    
    // File Input Handling
    document.querySelector('#file-input').onchange = function(e) {
        const file = e.target.files[0];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('room_id', roomId);
        formData.append('user_id', userId);
    
        fetch('/chat/upload_file/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            chatSocket.send(JSON.stringify({
                'type': 'file_share',
                'user_id': userId,
                'file_url': data.file_url,
                'file_name': file.name,
                'file_type': data.file_type
            }));
            console.log('File uploaded:', data);
        })
        .catch(error => {
            console.error('Error uploading file:', error);
        });
    
        e.target.value = '';
    };

   
     // Initialize Bootstrap modals
     var myModal = new bootstrap.Modal(document.getElementById('groupMembersModal'), {
        keyboard: false
    })

    // Add event listener for the "View Members" button
    document.querySelector('[data-bs-target="#groupMembersModal"]').addEventListener('click', function() {
        myModal.show();
    });
</script>
{% endblock %}
